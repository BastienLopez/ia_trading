//@version=5
strategy("Advanced Scalping Strategy with Improvements", overlay=true)

// Inputs
ema_fast_length = input.int(9, title="EMA Fast Length")
ema_slow_length = input.int(21, title="EMA Slow Length")
rsi_length = input.int(14, title="RSI Length")
rsi_overbought = input.int(70, title="RSI Overbought Level")
rsi_oversold = input.int(30, title="RSI Oversold Level")
bollinger_length = input.int(20, title="Bollinger Bands Length")
bollinger_mult = input.float(2.0, title="Bollinger Bands Multiplier")
atr_length = input.int(14, title="ATR Length")
atr_mult = input.float(1.5, title="ATR Multiplier")
supertrend_length = input.int(10, title="Supertrend Length")
supertrend_factor = input.float(3.0, title="Supertrend Factor")
trail_activation = input.float(1.5, title="Trailing Stop Activation (%)", step=0.1)
trail_distance = input.float(1.0, title="Trailing Stop Distance (%)", step=0.1)

// Indicators
ema_fast = ta.ema(close, ema_fast_length)
ema_slow = ta.ema(close, ema_slow_length)
rsi = ta.rsi(close, rsi_length)
[bb_upper, bb_lower, _] = ta.bb(close, bollinger_length, bollinger_mult)
atr = ta.atr(atr_length)

// Supertrend
[supertrend_upper, supertrend_lower] = ta.supertrend(supertrend_length, supertrend_factor)
supertrend_direction = ta.supertrenddir(supertrend_length, supertrend_factor)

// Trailing Stops
var float trailing_stop = na
if (strategy.position_size > 0)
    trailing_stop := na(trailing_stop) ? close * (1 - trail_distance / 100) : max(trailing_stop, close * (1 - trail_distance / 100))
    if close <= trailing_stop
        strategy.close("Buy", comment="Trailing Stop Triggered")

if (strategy.position_size < 0)
    trailing_stop := na(trailing_stop) ? close * (1 + trail_distance / 100) : min(trailing_stop, close * (1 + trail_distance / 100))
    if close >= trailing_stop
        strategy.close("Sell", comment="Trailing Stop Triggered")

// Pivot Support/Resistance
pivot_high = ta.pivothigh(high, 10, 10)
pivot_low = ta.pivotlow(low, 10, 10)
plot(pivot_high, color=color.red, linewidth=1, style=plot.style_circles, title="Resistance")
plot(pivot_low, color=color.green, linewidth=1, style=plot.style_circles, title="Support")

// MACD Divergences
[macdLine, signalLine, _] = ta.macd(close, 12, 26, 9)
bullish_divergence = ta.pivotlow(low, 5, 5) and low < ta.lowest(low, 10) and macdLine > ta.lowest(macdLine, 10)
bearish_divergence = ta.pivothigh(high, 5, 5) and high > ta.highest(high, 10) and macdLine < ta.highest(macdLine, 10)
plotshape(series=bullish_divergence, title="Bullish Divergence", location=location.belowbar, color=color.green, style=shape.labelup, text="BullDiv")
plotshape(series=bearish_divergence, title="Bearish Divergence", location=location.abovebar, color=color.red, style=shape.labeldown, text="BearDiv")

// Plot Signals
plot(ema_fast, color=color.blue, title="EMA Fast")
plot(ema_slow, color=color.red, title="EMA Slow")
plot(bb_upper, color=color.green, title="Bollinger Upper Band", style=plot.style_line)
plot(bb_lower, color=color.red, title="Bollinger Lower Band", style=plot.style_line)
hline(rsi_overbought, "RSI Overbought", color=color.red, linestyle=hline.style_dotted)
hline(rsi_oversold, "RSI Oversold", color=color.green, linestyle=hline.style_dotted)
plot(supertrend_upper, color=color.green, title="Supertrend Upper", linewidth=1, style=plot.style_stepline)
plot(supertrend_lower, color=color.red, title="Supertrend Lower", linewidth=1, style=plot.style_stepline)

// Buy/Sell Conditions
buy_condition = ta.crossover(ema_fast, ema_slow) and close < bb_lower and rsi < rsi_oversold and supertrend_direction == 1
sell_condition = ta.crossunder(ema_fast, ema_slow) and close > bb_upper and rsi > rsi_overbought and supertrend_direction == -1

if buy_condition
    strategy.entry("Buy", strategy.long)

if sell_condition
    strategy.entry("Sell", strategy.short)
